'use strict'

const fsp = require('node:fs/promises')
const ospath = require('node:path')

const DEFAULT_COMMAND = 'asciidoctor-pdf'

async function convert (runCommand, file, convertAttributes, buildConfig) {
  const { cwd = process.cwd(), command = await getDefaultCommand(cwd) } = buildConfig
  const args = convertAttributes.toArgs('-a', command).concat('-o', convertAttributes.outfile, '-')
  await runCommand(command, args, { parse: true, cwd, stdin: file.contents, stdout: 'print', stderr: 'print' })
}

function getDefaultCommand (cwd) {
  return fsp.access(ospath.join(cwd, 'Gemfile.lock')).then(
    () => `bundle exec ${DEFAULT_COMMAND}`,
    () => DEFAULT_COMMAND
  )
}

module.exports = {
  bind (thisArg, runCommand) {
    return Object.assign({}, this, { convert: convert.bind(thisArg, runCommand) })
  },
  convert,
  backend: 'pdf',
  extname: '.pdf',
  mediaType: 'application/pdf',
}
